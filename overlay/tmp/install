#!/bin/sh

set -euo pipefail
export BCG_E=`basename ${0}`


#======================================================================================================================
# Add dbadm user.
#======================================================================================================================

bcg-adduser dbadm


#======================================================================================================================
# Get MariaDB version.
#======================================================================================================================

cd /tmp

VERSION=$(cat VERSION)
bcg-debug "MariaDB version ${VERSION}."


#======================================================================================================================
# Install MariaDB and dependencies.
#======================================================================================================================

bcg-echo "Installing MariaDB v${VERSION}..."
apk add --no-cache \
    bash \
    openssl \
    mariadb=${VERSION} \
    mariadb-client=${VERSION} \
    mariadb-server-utils=${VERSION}
bcg-done


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bcg-debug "Cleaning up default database config and files."
rm -rf /etc/my.cnf* /etc/mysql /var/lib/mysql/*


#======================================================================================================================
# Create mariab directories.
#======================================================================================================================

bcg-debug "Creating mariadb directories."

mkdir -p /var/lib/backup

mkdir -p /etc/my.cnf.d/ssl
mkdir /ssl


#======================================================================================================================
# Add backup executable to main cron.
#======================================================================================================================

bcg-debug "Adding db-backup to cron."
echo "0 */8 * * * /usr/local/bin/db-backup" >> /etc/crontabs/root
