#!/usr/bin/env bash

# THE MIT LICENSE (MIT)
#
# Copyright © 2020 bcg|design
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
# documentation files (the “Software”), to deal in the Software without restriction, including without limitation the
# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit
# persons to whom the Software is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all copies or substantial portions of the
# Software.
#
# THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
# WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
# COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
# OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


# ======================================================================================================================
# SET VARIABLES
# ======================================================================================================================

BACKUP_PATH=/var/lib/backup
DATE=$(date '+%Y%m%d%H%M')
THIS_BACKUP_PATH=$BACKUP_PATH/$DATE
[[ -z "$BACKUP_COMPRESS_FILES" ]] && BACKUP_COMPRESS_FILES="0"
[[ -z "$BACKUP_KEEP_FOR_DAYS" ]] && BACKUP_KEEP_FOR_DAYS="14"


# ======================================================================================================================
# GET DATABASES
# ======================================================================================================================

DATABASES=$(mysql --password=$MARIADB_ROOT_PASSWORD --user=root -e 'SHOW DATABASES;' | sed 1d | grep -v -E "(mysql|information_schema|performance_schema)")
if [ "$DATABASES" == "" ] ; then
    exit
fi


# ======================================================================================================================
# ENSURE BACKUP PATH EXISTS
# ======================================================================================================================

if [ ! -d $BACKUP_PATH ] ; then
    mkdir -p $BACKUP_PATH
    chmod 740 $BACKUP_PATH
fi

mkdir $THIS_BACKUP_PATH
chown mysql:mysql $THIS_BACKUP_PATH
chmod 740 $THIS_BACKUP_PATH


# ======================================================================================================================
# PERFORM BACKUPS TO TEMP DIR
# ======================================================================================================================

 cd /tmp

for DATABASE in $DATABASES ; do
    if [ -f $DATABASE.sql ] ; then
        rm -f $DATABASE.sql
    fi

    mysqldump --add-locks --password=$MARIADB_ROOT_PASSWORD --user=root $DATABASE > $DATABASE.sql
done


# ======================================================================================================================
# MOVE BACKUPS TO BACKUP FOLDER AND GZIP
# ======================================================================================================================

cd $THIS_BACKUP_PATH

for DATABASE in $DATABASES ; do
    if [ -f /tmp/$DATABASE.sql ] ; then
        mv /tmp/$DATABASE.sql $DATABASE.sql
        chmod 640 $DATABASE.sql

        if [ "$BACKUP_COMPRESS_FILES" -eq "1" ] ; then
            gzip $DATABASE.sql
        fi
    fi
done


# ======================================================================================================================
# REMOVE OLD BACKUPS
# ======================================================================================================================

if [ "$BACKUP_KEEP_FOR_DAYS" -gt 0 ] ; then
    echo "Deleting backups older than $BACKUP_KEEP_FOR_DAYS days"
    MMIN=$((60*24*$BACKUP_KEEP_FOR_DAYS))
    find $BACKUP_PATH/* -type d -mmin +$MMIN | xargs rm -rf
fi
