#!/usr/bin/env bash

DATABASES=$(mysql --password=${MARIADB_ROOT_PASSWORD} --user=root -e 'show databases;' | sed 1d | grep -v -E "(mysql|information_schema|performance_schema)")
MAXIMUM=14

if [ "${DATABASES}" == "" ]
then
  exit
fi

BACKUP_PATH=/var/lib/backup

if [ ! -d ${BACKUP_PATH} ]
then
  mkdir -p ${BACKUP_PATH}
  chmod 740 ${BACKUP_PATH}
fi

cd /tmp

for DATABASE in ${DATABASES}
do
  if [ -f /tmp/${DATABASE}.sql ]
  then
    rm -f /tmp/${DATABASE}.sql
  fi

  mysqldump --add-locks --password=${MARIADB_ROOT_PASSWORD} --user=root ${DATABASE} > /tmp/${DATABASE}.sql
done

DATE=$(date '+%Y%m%d%H%M')
mkdir -p ${BACKUP_PATH}/${DATE}
chmod 740 ${BACKUP_PATH}/${DATE}
cd ${BACKUP_PATH}/${DATE}

for DATABASE in ${DATABASES}
do
  if [ -f /tmp/${DATABASE}.sql ]
  then
    mv /tmp/${DATABASE}.sql ${DATABASE}.sql
    gzip ${DATABASE}.sql
    chmod 640 ${DATABASE}.sql.gz
  fi
done

if [ ${BACKUP_KEEP_FOR_DAYS} -gt 0 ] ; then
  echo "Deleting backups older than ${BACKUP_KEEP_FOR_DAYS} days"
  find ${BACKUP_PATH}/* -mtime +${BACKUP_KEEP_FOR_DAYS} -exec rm {} \;
fi