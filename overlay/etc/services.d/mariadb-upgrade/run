#!/usr/bin/with-contenv bash

#======================================================================================================================
# Wait until MariaDB is running before attempting the upgrade
#======================================================================================================================

if [ -d "/var/lib/mysql/mysql" ] && [ ! -z "$(pidof mariadbd)" ]; then

    # run upgrade executable
    _echo "$(mariadb --version)"
    db-upgrade

    # disable the upgrade service
    db-upgrade-disable

else

    # wait 2s before exiting the service - S6 will keep restarting it until MariaDB comes online
    # on first run, the mariadb service will disable this upgrade service itself
    _echo "Waiting for MariaDB to come online..."
    sleep 2s

fi
